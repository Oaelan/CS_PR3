<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>제품 등록</title>
<style>
    /* 기본 글꼴을 나눔고딕체로 설정 */
body {
	font-family: 'Nanum Gothic', sans-serif;
	height: 100%;
}

.form-control {
	width: calc(100% - 50px);
	margin-right: 25px;
	margin-left: 25px;
}

.btn-block {
	width: calc(100% - 50px);
	padding: 0.375rem 1.25rem;
	margin-left: 25px;
}

.form-row {
	justify-content: center;
}

.product-list {
	margin-top: 50px;
	float: left;
	width: 60%;
	/* 제품목록 박스의 너비 조정 */
	margin-right: 30px;
	/* 오른쪽 여백 설정 */
}

.product-list {
	overflow-y: auto;
	max-height: 330px; /* 최대 높이 설정 */
}

.warehouse-section {
	margin-top: 50px;
	float: left;
	width: 30%;
	/* 창고온도 박스의 너비 조정 */
}

.product-table {
	margin-top: 20px;
	margin-left: auto;
	margin-right: auto;
	text-align: center;
}

.product-table th, .product-table td {
	padding: 10px;
	text-align: center;
	vertical-align: middle;
	border-bottom: none;
}

.table thead th {
	border-bottom: none;
}

.btn-stock {
	padding: 5px 10px;
	font-size: 12px;
}

.product-list .card-header h6 {
	margin-left: 25px;
}

/* 추가한 스타일 */
.warehouse-section {
	margin-top: 50px;
	padding: 10px;
	background-color: #f0f0f0;
	border: 1px solid #ccc;
	height: 100px;
	/* 높이를 조정하여 박스 크기를 줄임 */
}

.warehouse-header {
	font-size: 18px;
	font-weight: bold;
	margin-bottom: 10px;
}

.warehouse-message {
	font-size: 14px;
}

#search {
	border: 1px solid lightgray;
	border-radius: 3px;
}

#search:focus {
	outline: none;
}

#icon {
	border: none;
}
    .header {
	display: flex;
	align-items: center;
	justify-content: center;
	padding: 20px;
	width: 100%;
	height: 100px;
	border-bottom: 1px solid lightgray;
}

.menu {
	background-color: white;
	padding: 20px;
	height: 60px;
	border-bottom: 1px solid lightgray;
	display: flex;
	align-items: center;
	justify-content: center;
	box-sizing: border-box;
}

.menu ul {
	display: flex;
	padding: 0;
	list-style: none;
	justify-content: center;
	align-items: center;
	width: 100%;
	box-sizing: border-box;
	margin-bottom: 0px;
}

.menu li {
	display: inline;
	margin: 0 120px;
	font-size: 18px;
	position: relative;
	font-family: 나눔고딕;
	box-sizing: border-box;
}

.menu a {
	text-decoration: none;
	color: #333;
	font-weight: bold;
	box-sizing: border-box;
}
.temps {
	color: white!important;
}

.toast-container {
	position: fixed;
	top: 1rem;
	right: 1rem;
	z-index: 1080;
}

.state {
	width: 15%;
}

.temp {
	width: 25%;
}

.time {
	width: 50%;
}

#tempCon {
	overflow-y: auto;
	max-height: 330px;
}

#stockL {
	cursor: pointer;
}

body {
	height: 100%;
	font-family: 나눔고딕;
}

#invenNotice {
	font-weight: bold;
}

.stockList, .stockT {
	width: 100px;
	text-align: center;
}

.checkB {
	width: 100px;
}

.nonB {
	border: none;
	cursor: default;
	pointer-events: none;
}

#stockTitle {
	display: flex;
	width: 100%;
	justify-content: space-between;
	padding: 10px;
	font-weight: bold;
	background-color: #f1f1f1; /* 배경색 추가 (선택 사항) */
	border-bottom: 1px solid #ddd;
	padding: 10px; /* 하단 경계선 추가 (선택 사항) */
}

#stockProduct {
	display: flex;
	flex-direction: column;
	padding: 10px;
}

.stockCont {
	display: flex;
	width: 100%;
	justify-content: space-between;
	padding: 10px;
	border-bottom: 1px solid #ddd; /* 하단 경계선 추가 (선택 사항) */
	padding: 5px 0; /* 위 아래 패딩 추가 */ .
	stockCont: last-child{
    border-bottom: none; /* 마지막 항목의 하단 경계선 제거 */
}

header {
	background-color: #007bff;
	color: white;
}
</style>
<!-- header css 링크 -->
<link rel="stylesheet" href="../resources/css/header.css">
 <!-- Flatpickr CSS -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<!-- 부트스트랩 아이콘 링크 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- 부트스트랩 CDN 링크 -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<!-- 나눔고딕체 CDN 링크 -->
<link href="https://cdn.jsdelivr.net/npm/font-nanum@1.1.2/css/nanum.min.css" rel="stylesheet">
<link href="../resources/css/productRegister.css?ver=24" rel="stylesheet">
</head>
<body>
    
    <div class="header">
        <h2>관리자 전용 페이지</h2>
    </div>
    <div class="menu">
        <ul>
           <li><a href="index.html">제품등록</a></li>
            <li><a href="oList.html">주문내역</a></li>
            <li><a href="shipment.html">출하관리</a></li>
            <li><a href="deliveryState.html">배송상태</a></li>
        </ul>
    </div>

	<!-- Toast container -->
	<div class="toast-container" style="width: 15%;">
	    <!-- 온도 관련 Toast -->
	    <div class="toast" id="toast" role="alert" aria-live="assertive" aria-atomic="true" data-autohide="false">
	        <div class="toast-header" id ="toast-header">
	            <i class="bi bi-thermometer-high" class="rounded mr-2" alt="Icon"></i> 
	            <strong class="mr-auto">물류 창고 온도 이상</strong>
	            <small class="text-muted">just now</small>
	            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
	                <span aria-hidden="true">&times;</span>
	            </button>
	        </div>
	        <div class="toast-body">
	         		<p id="tempState">현재 온도가 높습니다.</p>
	        </div>
	    </div>
	</div>
	
	<div class="container" style="display: flex; flex-direction: column; gap: 30px";>
		<div class="container mt-5">
			<!-- 제품 등록 폼 -->
			<div class="row">
				<div class="col-lg-12 mx-auto">
					<div class="card pb-4">
						<div class="card-body p-0">
							<!-- 얇은 헤더 -->
							<header class="py-2 mb-4">
								<div class="container text-center">
									<h6 class="m-0">재고 등록</h6>
								</div>
							</header>
							<form method="post" action="/upload" id="pUploadF">
								<!-- 첫 번째 줄 -->
								<div class="form-row">
									<div class="form-group col-md-4">
										<label for="productName" style="margin-left: 25px;">제품명</label> <select name="p_name" id="pNameSelect" class="form-control form-control-sm" style="margin-left: 25px;" required="required">
											<!-- 옵션들 추가 -->
										</select>
									</div>
									<div class="form-group col-md-4">
										<label for="productionDate" style="margin-left: 25px;">생산날짜</label> <input type="date" name="m_date" class="form-control form-control-sm" id="productionDate" style="margin-left: 25px;" required="required">
									</div>
									<div class="form-group col-md-4">
										<label for="productPrice" style="margin-left: 25px;">제품단가</label> <select name="p_price" id="pPriceSelect" class="form-control form-control-sm" style="margin-left: 25px;" required="required">
											<!-- 옵션들 추가 -->
										</select>
									</div>
								</div>
								<!-- 두 번째 줄 -->
								<div class="form-row">
									<div class="form-group col-md-4">
										<label for="productionQuantity" style="margin-left: 25px;">생산수량</label> <input type="number" name="m_num" class="form-control form-control-sm" id="productionQuantity" placeholder="생산수량 입력" style="margin-left: 25px;" required="required">
									</div>
									<div class="form-group col-md-4">
										<label for="expiryDate" style="margin-left: 25px;">유통기한</label> <input type="date" name="p_limitD" class="form-control form-control-sm" id="expiryDate" style="margin-left: 25px;" required="required">
									</div>
									<div class="form-group col-md-4 d-flex align-items-end">
										<button type="submit" class="btn btn-primary btn-block btn-sm" id="uploadBtn" style="margin-left: 25px;">등록하기</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
			<div id="listTempCon" style="display: flex;">
				<!-- 제품 목록 -->
				<div class="product-list mr-0">
					<div class="col-lg-10 p-0" id="product-list" style="max-width:100%">
						<div class="card">
							<div class="card-body p-0">
								<header class="bg-light py-2 m-0">
									<div class="container text-left pl-4" style="display: flex; justify-content: space-between; align-items: center">
										<h6 class="m-0" style="display: inline;" id="stockL">재고 목록</h6>
										<div>
											<input type="text" id="search" name="searchWord" placeholder="제품명 검색" style="padding-left: 5px; font-size: 14px; margin-right: 5px;">
											<button id="serachB">
												<i class="bi bi-search" style="display: inline;"></i>
											</button>
										</div>
									</div>
								</header>
								<table class="table product-table m-0">
									<thead class="thead-light">
										<tr>
											<th>제품코드</th>
											<th>제품명</th>
											<th>제품단가</th>
											<th>재고 수</th>
											<th>제품관리</th>
										</tr>
									</thead>
									<tbody id="pList">
										<!-- 상품 리스트들이 출력됨 -->
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<!-- 창고 온도 섹션 -->
				<!-- 얇은 헤더 -->
				<div class="warehouse-section p-0" id="tempCon" style="width:40%; height: 330px; border-radius: 3px;">
					<header class="bg-light py-2 mb-4">
						<div class="container text-center p-0">
							<h6 class="m-0 font-weight-bold" id="nowTemp">현재 창고 온도 :</h6>
								<div id="selectBoxCon" style="display:flex;justify-content: center;">						
								</div>						
						</div>
					</header>
					<div class="col mt-4" id="tempList">
						<div class="warehouse-message" style="text-align: center;"></div>
					</div>
				</div>
				<!--  온도 데이터 검색 창 -->
				<div class="warehouse-section p-0" id="tempCon2" style="width:40%; height: 330px; border-radius: 3px;">
					<header class="bg-light py-2 mb-4">
						<div class="container text-center p-0">						
								<div id="selectBoxCon" style="display:flex;justify-content: center;">			
									<select id="year" style="padding: 3px;">
										<option disabled selected>년도</option>
									</select>
									
									<select id="month" style="padding: 3px;">
										<option disabled selected>월</option>
									</select>
									
									<select id="day" style="padding: 3px;">
										<option disabled selected>일</option>
									</select>
									
									<select id="state" style="padding: 3px;">
										<option disabled selected>상태</option>
										<option value="normal">normal</option>	
										<option value="high">high</option>
										<option value="low">low</option>																		
									</select>								
								</div>						
						</div>
					</header>
					<div class="col mt-4" id="tempList2">
						<div class="warehouse-message" style="text-align: center;"></div>
					</div>
				</div>
				
			</div>
		</div>
		<div class="container" style="display: flex; justify-content:space-between;margin-bottom:100px;">
			<!--  등록되어 있는 상품 리스트(판매를 하기 위해 등록한 상품 리스트) -->
			<div class="product-list m-0" style="width: 60%;">
				<div class="card">
					<div class="card-body p-0">
						<header class="bg-light py-2 m-0">
							<div class="container text-left pl-4" style="display: flex; justify-content: space-between;">
								<h6 class="m-0" style="display: inline;">상품 목록</h6>
							</div>
						</header>
						<table class="table product-table m-0">
							<thead class="thead-light">
								<tr>
									<th>제품 코드</th>
									<th>제품명</th>
									<th>제품단가</th>
								</tr>
							</thead>
							<tbody id="mList">
								<!-- 상품 리스트들이 출력됨 -->
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<!-- 새 상품 등록 창 -->
			<div class="form-container" style="width: 40%; width: 40%; display: flex; justify-content: center; align-items: center; flex-direction: column;">
				<div class="form-header">
					<h5 style="text-align: center">상품 등록</h5>
				</div>
				<form id="productForm" style="display: flex; flex-direction: row; justify-content: center; align-items: center;" action="/uploadProductInfo">
					<div id="formCon1">
						<div class="form-group" style="display: flex; justify-content: space-evenly; align-items: center;">
							<label for="pName" class="m-0" style="text-align: center">품명</label> <input type="text" class="form-control m-0" id="pName" name="p_name" required style="width: 70%;">
						</div>
						<div class="form-group m-0" style="display: flex; justify-content: space-evenly; align-items: center;">
							<label for="pPrice" class="m-0" style="text-align: center">단가</label> <input type="number" class="form-control m-0" id="pPrice" name="p_price" required style="width: 70%;">
						</div>
					</div>
					<div id="pUoadBCon" style="height:100%;">
						<button type="submit" class="btn btn-primary btn-register" style="width: 100%; height:100%;">등록</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<!-- 재고관리 모달 -->
	<div id="stockModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="stockModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="stockModalLabel">재고 관리</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
					
						<div class="modal-body">
							<div id="stockTitle">							
								<p id="modalPNo" class="m-0 stockT">선택</p>							
								<p id="modalMDate" class="m-0 stockT">입고 날짜</p>
								<p id="modalPLimitD" class="m-0 stockT">유통 기한</p>	
								<p id="modalMNum" class="m-0 stockT">재고 수량</p>												
							</div>
							<div id="stockProduct"></div>
						</div>
						<div class="modal-footer" style="display: flex; justify-content: space-between;">
							<p id="invenNotice">* 수량 더블 클릭 시 수정 가능 / 폐기는 체크 후 가능</p>
								<div id="btnC">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
									<button type="submit" class="btn btn-danger discardButton" id="discardButton">폐기</button>
									<button type="submit" class="btn btn-primary editButton" id="editButton">수정</button>							
								</div>
						</div>
			</div>
		</div>
	</div>
	<!-- 상품 등록시 값이 비워져 있을 때 뜨는 모달 창 -->
	<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">제품 등록 오류</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    	등록 정보를 모두 입력 또는 상품과 단가를 다시 확인해 주세요.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 재고 검색시 등록된 재고가 없을 때 뜨는 모달 -->
    <div class="modal fade" id="noProductModal" tabindex="-1" role="dialog" aria-labelledby="noProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="noProductModalLabel">재고 등록이 필요합니다.</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    	등록된 재고 정보가 없습니다.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
	<!-- 부트스트랩 자바스크립트 및 jQuery CDN 링크 -->
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@1.16.1/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<!-- productRegister페이지 관련 js -->
	<script type="text/javascript" src="../resources/js/productRegister.js"?ver=1224></script>
	<script type="text/javascript">
		document.addEventListener('DOMContentLoaded', function() {
    // 등록 된 상품 리스트 들고 옴
    selectProductInfo();
    //등록된 재고 리스트 들고옴
    getProductList();
    // 등록되어 있는 상품들의 정보를 들고옴
    productsInfo();
    // 상품명 선택 시 자동으로 단가 선택 됨
    autoPriceSelect();
    // 물류 창고 온도 가져오기(1초마다 가져오기)
    setInterval(selectFactoryTemp, 1000);
    // 창고 온도에 따라 토스트 창 띄우는 함수
    setInterval(toastForTem, 1000);
  // 상품등록시 새로고침 되는 함수
    uploadReload()
    //등록 폼에 submit 이벤트 리스너 추가 상품 등록시 상품과 단가가 맞이 않으면 등록 불가 기능
    document.getElementById("pUploadF").addEventListener("submit", isCorrectPrice);
    // 검색버튼에 상품명/상품코드로 검색할 수 있는 기능 
    document.getElementById("serachB").addEventListener("click", searchProduct);
    //(검색 후 ) 재고 목록 타이틀을 눌렀을 때 전체 목록 다시 가져오기 위해 새로 고침 하는 기능
    document.getElementById("stockL").addEventListener("click", ()=>{
        location.reload();
    });
    
   
});

// 상품 등록시 새로고침 되는 함수
function uploadReload(){
    let uploadB = document.getElementById("productFrom");
    uploadB.addEventListsner("submit",()=>{
        location.reload(); // 페이지 즉시 새로 고침(변경된 재고 수 웹 브라우저에 실시간 반영을 위함)
    })
}

//온도 이상 감지에 따라 생기는 토스트창 함수
async function toastForTem() {
    const nowTempForM = await selectFactoryTemp();
    console.log(nowTempForM)
    //토스트 메시지 창
    let toastHeader = document.getElementById("toast-header");
    toastHeader.innerHTML =" ";  
    // 토스트 메시지
    let tempState = document.getElementById("tempState");
    // 토스트 창 
    var toast = document.getElementById('toast');
    $(toast).toast({
        // x버튼을 눌러 닫기 전 까지 안 사라짐
      autohide: false 
    });
    
    if (nowTempForM !== undefined) {
        if(nowTempForM <=25){
            // 조건에 따라 토스트 메시지와 디자인 설정
            tempState.InnerText = "현재 온도가 낮습니다."
            toastHeader.style.background ="blue";
            toastHeader.style.color = 'white';    
            toastHeader.innerHTML =  '<i class="bi bi-thermometer-high rounded mr-2" aria-hidden="true"></i>' +
            '<strong class="mr-auto">물류 창고 온도 이상</strong>' +
            '<small class="temps">just now</small>' +
            '<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span>' +
            '</button>';
            $(toast).toast('show');
        }else if(nowTempForM >=29){
            // 조건에 따라 토스트 메시지와 디자인 설정
            tempState.InnerText = "현재 온도가 높습니다."
            toastHeader.style.background ="red";
            toastHeader.style.color = 'white';    
            toastHeader.innerHTML =  '<i class="bi bi-thermometer-high rounded mr-2" aria-hidden="true"></i>' +
            '<strong class="mr-auto">물류 창고 온도 이상</strong>' +
            '<small class="temps" >just now</small>' +
            '<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span>' +
            '</button>';
            $(toast).toast('show');
        }else{
            $(toast).toast('hide');
        }
    }
}
//등록 된 상품 리스트 들고오는 함수
function selectProductInfo(){
    // POST 요청 보내기
    fetch('/product/selectProductInfo', {
        headers: {
            'Accept': 'application/json', // 전송할 데이터의 타입
        }
    })
    .then(response => response.json()) // 응답을 JSON으로 변환
    .then(results => {
       // console.log('Success:', result); // 성공적으로 처리된 결과를 출력
        let productInfoHTML ="";
        let productInfoHTMLCon = document.getElementById("mList");
        results.forEach(result =>{
            productInfoHTML+=
           '<tr>'+'<td>'+result.p_no+'</td>'+
            '<td>'+result.p_name +'</td>' +
            '<td>'+result.p_price  +'</td>'  +
            '</tr>';
        })
        
        productInfoHTMLCon.innerHTML = productInfoHTML;
    })
    .catch(error => {
        console.error('Error:', error); // 오류가 발생한 경우
            });
        }

//등록 된 재고 리스트를 불러오는 함수
function getProductList() {
    fetch('/product/list', {
        headers: {
            'Accept': 'application/json' // JSON 응답 요청
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('상품리스트 리턴 타입 확인'); // 응답 오류 처리
        }
        return response.json(); // 응답 본문을 JSON으로 변환
    })
    .then(productLists => {
        // 전체 재고 리스트
        //console.log(productLists); // 데이터를 처리       
        // 재고 리스트들이 들어갈 tbody
        let tbody = document.getElementById("pList");
        // tbody 초기화
        tbody.innerHTML = "";       
        // 재고 리스트 forEach 돌려서 출력
        productLists.forEach(product => {         
            // 재고 정보를 담는 변수 
            let listCont = 
                '<tr class="products">' +
                '<td>' + product.p_no + '</td>' +
                '<td>' + product.p_name + '</td>' +
                '<td>' + product.p_price + '원</td>' +
                '<td>' + product.m_num + '개</td>' +
                '<td>' +
                '<button class="btn btn-info btn-stock btn-sm" ' +
                'id="' + product.p_no + '" ' + // id 설정
                'data-toggle="modal" ' +
                'data-target="#stockModal">' +
                '재고관리' +
                '</button>' +
                '</td>' +
                '</tr>';             
            // 되어 있는 상품을 tbody에 담아서 출력
            tbody.innerHTML += listCont;
        });  
        // 재고관리 버튼
        let buttons = document.querySelectorAll(".btn-stock");
        //console.log(buttons)
        // 재고관리 버튼 눌렀을 때 해당 상품의 코드 번호를 넘겨주고 유통기한별 상품 정보 가져오는 함수 호출
        groupByDate(buttons);            
    })
    .catch(error => {
        console.error('상품 리스트 출력 불가:', error);
    });
}

// 재고 검색 기능 함수
function searchProduct(){
    let  searchWord = document.getElementById("search").value;
    console.log(searchWord)
    fetch('/product/searchProduct?searchWord='+searchWord,{
       headers:{
           'Accept': 'application/json'
       } 
    })
    .then(response =>{
        if(!response.ok){
            throw new Error('서버로부터의 응답이 이상함 ' + response.statusText);
        }
        return response.json();
    })
    .then(response=>{
        // 상품 리스트들이 들어갈 tbody
        let tbody = document.getElementById("pList");
        // tbody 초기화
        tbody.innerHTML = "";  
        let searchResultHTML;
        searchResultHTML = '<tr class="products">' +
                                                        '<td>' + response.p_no + '</td>' +
                                                        '<td>' + response.p_name + '</td>' +
                                                        '<td>' + response.p_price + '원</td>' +
                                                        '<td>' + response.m_num + '개</td>' +
                                                        '<td>' +
                                                        '<button class="btn btn-info btn-stock btn-sm" ' +
                                                        'id="' + response.p_no + '" ' + // id 설정
                                                        'data-toggle="modal" ' +
                                                        'data-target="#stockModal">' +
                                                        '재고관리' +
                                                        '</button>' +
                                                        '</td>' +
                                                        '</tr>';        
        tbody.innerHTML += searchResultHTML;
    })
    .catch(error => {   
        console.error('네트워크 요청 실패:', error);
        $('#noProductModal').modal('show'); // 모달 창 띄우기   
    });
};


//productsInfo 테이블에 등록되어 있는 제품 정보 들고오기
    function productsInfo() {
    fetch('/product/productsInfo', {
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('서버로부터의 응답이 이상함 ' + response.statusText);
        }
        return response.json();
    })
    .then(datas => { 
        // 상품 등록 시 상품 이름 셀렉트 창의 옵션
        let productName = "";
        //상품 등록 시 상품 단가 셀렉트 창의 옵션
        let productPrice = "";
        // 데이터 처리 로직
        datas.forEach(data =>{
            productName+=
                '<option value="' + data.p_name + '">' + data.p_name + '</option>';
            
            productPrice +=
                '<option value="' + data.p_price + '" id="' +data.p_name  + '">' + data.p_price + '</option>';          
        });
        // 이름 셀렉트 태그
        let selectBoxN = document.getElementById("pNameSelect");
        selectBoxN.innerHTML = productName;
        // 가격 셀렉트 태그
        let selectBoxP = document.getElementById("pPriceSelect");
        selectBoxP.innerHTML = productPrice; 
    })
    .catch(error => {
        console.error('네트워크 요청 실패:', error);
    });
}

 // 상품 이름과 단가가 다를 때 submit 막기
    function isCorrectPrice(event) {
   
        // 상품 이름
        let name = document.getElementById("pNameSelect");
        // 상품 가격
        let price = document.getElementById("pPriceSelect");
     
        if(name.selectedIndex !== price.selectedIndex){
            // 가격이 일치하지 않으면 제출을 막고 모달을 띄우기
            $('#alertModal').modal('show'); // 모달 창 띄우기   
            event.preventDefault(); // 제출을 방지
        }          
    }
  
// 상품 등록 시 제품 선택하면 자동으로 제품 단가 값 선택 되는 함수
    function autoPriceSelect(){
        // 이름 셀렉트 태그
        let selectBoxN = document.getElementById("pNameSelect");    
        // 가격 셀렉트 태그
        let selectBoxP = document.getElementById("pPriceSelect");
        
        // 상품 선택에 따라 자동으로 단가 선택
        selectBoxN.addEventListener("change",()=>{  
            // 선택된 옵션의 값을 가져오기
            let selectedValue = selectBoxN.value;    
            console.log( selectedValue)   
            for(i=0; i<selectBoxP.options.length; i++){
                if(selectedValue == selectBoxP.options[i].id ){           
                    console.log( selectBoxP.options[i].id)
                    // 이 부분에 selectBoxP의 옵션 같이 위의 조건과 만족하는 옵션의 값으로 선택되게 하는           
                    selectBoxP.selectedIndex = i;
                    break;
                }
            }       
        });
        
    };
    

//재고관리 버튼에 이벤트 추가 함수
async function groupByDate(buttons) {
    // 선택한 상품의 코드를 담을 변수
    let p_no;
    let  stockCont;
    buttons.forEach(button => {
        button.addEventListener("click", async () => {
            // 선택할 상품의 코드 초기화
            p_no = button.id;
            try {
                // 재고관리 버튼 이벤트 추가 해당 상품의 p_no 넘겨주고 유통기한별 상품 정보 가져오기
                const { stockConts } = await groupByDateFetch(p_no);
             // console.log(stockConts); // 비동기 작업 후 결과를 출력    
         
                let products  =   updateInventNum(stockConts); 
                // 수정 기능 함수 호출
                updateInventB(products);
                // 폐기 기능 호출 함수                  
                disposeB(products);
                
            } catch (error) {
                console.error('데이터를 가져오는 중 오류 발생:', error);
            }            
        });
    });
}


     async function groupByDateFetch(p_no) {
         try {
             // 선택한 상품의 코드로 유통기한별 재고 수 들고오기
             const response = await fetch('/product/groupByDate?p_no=' + p_no, {
                 headers: {
                     'Accept': 'application/json' // JSON 응답 요청
                 }
             });
    
             if (!response.ok) {
                 throw new Error('리스폰 타입 확인');
             }
    
             const products = await response.json(); // 응답을 JSON 형식으로 변환
    
             // 유통기한 별 상품 정보를 담을 변수 초기화
             let groupByDateHtml = "";
             // groupByDate 정보를 담을 모달 창
             let stockProduct = document.getElementById("stockProduct");
             // 모달 창의 내용을 초기화
             stockProduct.innerHTML = "";
    
             // 유통기한별 상품 출력문
             products.forEach(product => {
                 // 유통기한을 id로 사용하기 전에 적절한 포맷으로 변환
                 let limitDateId = product.p_limitD.replace(/[^a-zA-Z0-9]/g, '_');
                 // 재고 관리 모달창 타이틀에 해당 상품명 넣을거임
                 let stockModalLabel = document.getElementById("stockModalLabel");
                 stockModalLabel.innerHTML = product.p_name;
                 groupByDateHtml +=
                     '<div class="stockCont">' +
                     '<input type="checkbox" class="mb-0 checkB stockList" name="disposeStock" id="'+product.m_date+'">' +
                     '<input type="text" hidden class="mb-0 nonB stockList" name="p_no" value="' + product.p_no + '" readonly>' +
                     '<input type="text" class="mb-0 nonB stockList" name="m_date" value="' + product.m_date + '" readonly>' +
                     '<input type="text" class="mb-0 nonB stockList" name="p_limitD" value="' + product.p_limitD + '" readonly>' +
                     '<input type="text" class="mb-0 stockList updateBtn m_num" id="' + limitDateId + '" name="m_num" value="' + product.m_num + '" readonly>' +
                     '</div>'; // input id값이 유통기한                 
             });
    
             // 모달 창에 가져온 데이터 넣기
             stockProduct.innerHTML = groupByDateHtml;
    
             // 수정 기능을 위한 변수(재고관리 모달창에 존재하는 데이터들을 객체로 담을거임)
             let stockConts = document.querySelectorAll(".stockCont");
             let updateBtns = document.querySelectorAll(".updateBtn");
    
             // 재고관리 모달창에 재고 수량 빼고 나머지 인풋값 못건들게 만드는 함수
             isReadonly(updateBtns);
             // 결과 반환
             return { stockConts };
         } catch (error) {
             console.error('컨트롤러 확인 또는 패치 헤더 확인', error); // 오류를 처리
             // 오류 발생 시 빈 배열 반환
             return { stockConts: [] };
         }
     }




//재고관리 모달에 있는 input에 이벤트 추가
function isReadonly(updateBtns) {
    updateBtns.forEach(updateBtn => {        
        //선택한 인풋 태그의 값을 담는 변수 
        let preNum = updateBtn.value;

        // 인풋 태그를 더블 클릭 시 수정 가능
        updateBtn.addEventListener("dblclick", () => {
            // readonly 속성이 있을 시 속성 제거 
            if (updateBtn.hasAttribute("readonly")) {
                updateBtn.removeAttribute("readonly"); // readonly 속성 제거                                    
            }           
        });

        // blur시 수정 가능 - > 불가능으로 바뀜
        updateBtn.addEventListener("blur", () => {
            updateBtn.setAttribute("readonly",true); // 수량 변경 시 다시 변경 불가                   
        });    
    });
}

// 창고 온도에 따라 모달 창 띄우는 함수
//async/await를 사용하여 결과 처리
/*async function tempForModal() {
    const nowTempForM = await selectFactoryTemp();
    console.log(nowTempForM);
    if (nowTempForM !== undefined) {
        if(nowTempForM <=25){
            $('#modal2').modal('show'); // 모달 창 띄우기   
        }else if(nowTempForM >=29){
            $('#modal1').modal('show'); // 모달 창 띄우기   
        }else{}
    }
}*/


//버튼 교체 함수
function replaceButton(button) {
    let newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    return newButton;
}

//폐기 기능
function disposeB(products) {
    let discardButton = document.getElementById("discardButton");

    // 기존 이벤트 리스너 제거 및 교체
    let newDiscardButton = replaceButton(discardButton);
    
    // 폐기 버튼 클릭 시 이벤트 리스너 정의
    newDiscardButton.addEventListener('click', function() {
        console.log("Inside event listener:", products);
        let updatePro = [];
        let disCheckB = document.querySelectorAll(".checkB");

        // 체크 박스가 선택되어 있다면 updatePro에 배열 저장
        for (let i = 0; i < products.length; i++) {
            if (disCheckB[i] && disCheckB[i].checked) {
                updatePro.push(products[i]);
            }
        }  
        disposeStockFetch(updatePro)
        location.reload(); // 페이지 즉시 새로 고침(변경된 재고 수 웹 브라우저에 실시간 반영을 위함)
        $('#stockModal').modal('hide'); // 모달 숨기기
    });
}

function updateInventB(products){
   // console.log(products);
    
  //재고 수정 버튼
    let editButton = document.getElementById("editButton");
    
    // 기존 이벤트 리스너 제거
    let newEditButton = editButton.cloneNode(true);
    editButton.parentNode.replaceChild(newEditButton, editButton);
    
    // 수정 버튼 클릭 시 이벤트 리스너를 정의
    newEditButton.addEventListener('click', function() {
       // console.log("Inside event listener:", products);

        // 수정할 재고들을 담을 변수
        let updatePro = [];
        // 모달창에 있는 재고 인풋태그 들고오기
        let productNums = document.querySelectorAll(".m_num");

        for (let i = 0; i < products.length; i++) {
            let currentNum = productNums[i].value;
            if (currentNum != products[i].m_num) {
                products[i].m_num = currentNum;
                updatePro.push(products[i]);              
            }
        }
        updateInventFetch(updatePro);
        location.reload(); // 페이지 즉시 새로 고침(변경된 재고 수 웹 브라우저에 실시간 반영을 위함)
        // jQuery를 사용하여 모달 닫기
        $('#stockModal').modal('hide'); // 모달 숨기기
    });
}


//재고 수정/ 폐기를 위해 사용되는 모달창에 있는 데이터 정보 담는 배열을 리턴 하는 함수
function updateInventNum(stockConts) {
    // 모달 창에 있는 재고를 담는 변수
    let products = [];
    
    // 모달 창에 있는 모든 재고 정보를 products 배열에 저장
    stockConts.forEach(cont => {
        let product = {
            p_no: cont.querySelector('input[name="p_no"]').value,
            m_date: cont.querySelector('input[name="m_date"]').value,
            p_limitD: cont.querySelector('input[name="p_limitD"]').value,
            m_num: cont.querySelector('input[name="m_num"]').value
        };
        products.push(product);
    });
    return products;
}


//재고 수정 fetch 함수
function updateInventFetch(updatePro){
    console.log("Update Inventory Fetch: ", updatePro);
    // POST 요청 보내기
    fetch('/product/updateStock', {
        method: 'POST',
        headers: {
            'Accept': 'application/json', // 전송할 데이터의 타입
            'Content-Type': 'application/json' // 전송할 데이터의 타입
        },
        body: JSON.stringify(updatePro) // 데이터 객체를 JSON 문자열로 변환
    })
    .then(response => response.json()) // 응답을 JSON으로 변환
    .then(result => {
        console.log('Success:', result); // 성공적으로 처리된 결과를 출력
    })
    .catch(error => {
        console.error('Error:', error); // 오류가 발생한 경우
    });
}

//재고 수정 fetch 함수
function disposeStockFetch(disposeProducts){
    // POST 요청 보내기
    fetch('/product/disposeStock', {
        method: 'POST',
        headers: {
            'Accept': 'application/json', // 전송할 데이터의 타입
            'Content-Type': 'application/json' // 전송할 데이터의 타입
        },
        body: JSON.stringify(disposeProducts) // 데이터 객체를 JSON 문자열로 변환
    })
    .then(response => response.json()) // 응답을 JSON으로 변환
    .then(result => {
        console.log('Success:', result); // 성공적으로 처리된 결과를 출력
    })
    .catch(error => {
        console.error('Error:', error); // 오류가 발생한 경우
            });
        }

//물류 창고 온도 fetch 함수
async function selectFactoryTemp() {
    try {
        const response = await fetch('/product/selectFactoryTemp', {
            headers: {
                'Accept': 'application/json', // 전송할 데이터의 타입       
            }
        });

        const results = await response.json(); // 응답을 JSON으로 변환

        let tempList = document.getElementById("tempList");
        let factoryTempListHTML = "";
        results.forEach(result => {
            factoryTempListHTML += 
                '<div class="warehouse-message" style="text-align: center; display:flex; justify-content: space-evenly; align-items: center;">' +
                '<p class="temp"> ' + result.now_temp + " °C</p>" +
                '<p class="time"> '+ result.time + "</p>" +
                '<p class="state"> ' + result.state + "</p>" +
                "</div>";
        });
        tempList.innerHTML = factoryTempListHTML;
        
        let temps = document.querySelectorAll(".temp");
        temps.forEach(temp => {         
            let tempN = temp.innerText.slice(0, -2);
            if (parseFloat(tempN) <= 25.0) {
                temp.parentNode.style.color = "blue";
            } else if (parseFloat(tempN) >= 29.0) {
                temp.parentNode.style.color = "red";
            }
            temp.parentNode.style.fontWeight = "bold";   
        });
       
        let nowTemp = document.getElementById("nowTemp");
        nowTemp.innerText = "현재 창고 온도 : " + temps[0].innerText;
        let nowTempForM = parseFloat(temps[0].innerText.slice(0, -2));
   
        if (nowTempForM <= 25.0) {
            nowTemp.style.color = "blue";
        } else if (nowTempForM >= 29.0) {
            nowTemp.style.color = "red";
        } else {
            nowTemp.style.color = "black";
        }

        // nowTempForM 값을 반환
        return nowTempForM;
    } catch (error) {
        console.error('Error:', error); // 오류가 발생한 경우
    }
}

	</script>
</body>
</html>